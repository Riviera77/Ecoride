{% extends 'base.html.twig' %}

{% block title %}Carpooling{% endblock %}

{% block body %}
    <div class="container my-5">

        <h1 class="mb-4">D√©tail du covoiturage</h1>

        <div class="card mb-4 overflow-hidden text-bg-dark shadow-lg">
            <div class="card-body">

                <div class="d-flex align-items-center flex-wrap gap-3">
                    <img src="{{ asset('uploads/users/' ~ carpooling.users.photo) }}" 
                        alt="photo conducteur"
                        class="rounded-circle img-fluid flex-shrink-0" 
                        width="100" 
                        height="100"
                        style="object-fit: cover;">
                    <div>
                        <h3 class="mb-1">{{ carpooling.users.username }}</h3>
                        <p class="mb-0">Note moyenne : 
                            {% if averageRating > 0 %}
                                ‚≠ê {{ averageRating }}/5
                            {% else %}
                                Pas encore not√©
                            {% endif %}
                        </p>
                    </div>
                </div>

                <hr>

                <div class="row row-cols-1 row-cols-md-2 g-3">
                    <div><strong>Ville de d√©part :</strong> {{ carpooling.departureAddress }}</div>
                    <div><strong>Ville d'arriv√©e :</strong> {{ carpooling.arrivalAddress }}</div>

                    <div><strong>Date de d√©part :</strong> {{ carpooling.departureDate ? carpooling.departureDate|date('Y-m-d') : '' }}</div>
                    <div><strong>Date d'arriv√©e :</strong>{{ carpooling.arrivalDate ? carpooling.arrivalDate|date('Y-m-d') : '' }}</div>
                    
                    <div><strong>Heure de d√©part :</strong> {{ carpooling.departureTime ? carpooling.departureTime|date('H:i:s') : '' }}</div>
                    <div><strong>Heure d'arriv√©e :</strong> {{ carpooling.arrivalTime ? carpooling.arrivalTime|date('H:i:s') : '' }}</div>
                    
                    <div><strong>Dur√©e estim√©e :</strong> {{ carpooling.duration ?? 'Non pr√©cis√©e' }}</div>
                    <div><strong>Prix :</strong> {{ carpooling.price }} ‚Ç¨</div>
                    
                    <div><strong>Nombre de places restantes :</strong> {{ carpooling.numberSeats - carpooling.passengers|length }}</div>
                    <div><strong>Pr√©f√©rences :</strong> {{ carpooling.preference ?? 'Aucune' }}</div>
                    
                    <div><strong>Statut :</strong> {{ carpooling.status }}</div>
                </div>
                
                <hr>

                <h4>V√©hicule</h4>
                {% if carpooling.cars %}
                    <div class="row row-cols-1 row-cols-md-3 g-2">
                        <div><strong>Mod√®le :</strong> {{ carpooling.cars.model }}</div>
                        <div><strong>Marque :</strong> {{ carpooling.cars.mark }}</div>
                        <div><strong>√ânergie :</strong> {{ carpooling.cars.energy ? '‚ö° √âlectrique' : 'Essence/Diesel' }}</div>
                    </div>
                {% else %}
                    <p class="mb-0">Pas de v√©hicule renseign√©</p>
                {% endif %}

                <hr>

                <h4>Commentaires des passagers</h4>
                {% if comments is not empty %}
                    <ul class="mb-0">
                        {% for comment in comments %}
                            <li>üí¨ {{ comment.comment }}</li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="mb-0">Aucun commentaire pour ce conducteur.</p>
                {% endif %}
            </div>
        </div>

        <div class="d-flex flex-column flex-md-row gap-2">
            <a href="{{ path('app_carpooling_index') }}" class="btn btn-outline-primary">Retour √† la liste</a>
            
            {% if app.user %}
                {% set alreadyPassenger = carpooling.passengers.contains(app.user) %}
                {% if alreadyPassenger %}
                    <div class="alert alert-info mt-3">
                        Vous participez d√©j√† √† ce covoiturage.
                    </div>
                {% elseif carpooling.numberSeats > 0 %}
                    <a href="{{ path('app_carpooling_participate', { id: carpooling.id }) }}" class="btn btn-primary mt-3">
                        Participer √† ce covoiturage
                    </a>
                {% else %}
                    <div class="alert alert-warning mt-3">
                        Il n'y a plus de places disponibles.
                    </div>
                {% endif %}
                {% else %}
                    <div class="card my-4 overflow-hidden text-bg-dark shadow-lg">
                        <a href="{{ path('app_login') }}">Connectez-vous</a> ou 
                        <a href="{{ path('app_register') }}">cr√©ez un compte</a> pour participer √† ce covoiturage.
                    </div>
            {% endif %}

            <a href="{{ path('app_carpooling_edit', {'id': carpooling.id}) }}" class="btn btn-primary">Modifier</a>
        </div>
    </div>

    {{ include('carpooling/_delete_form.html.twig') }}
{% endblock %}
